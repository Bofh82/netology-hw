# Домашнее задание к занятию «Резервное копирование баз данных» - Родионов Сергей
## Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

---

## Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

---

## Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

---

Задания, помеченные звёздочкой, — дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.

### **Ответы на задания**  

---

## **Задание 1. Резервное копирование**  

### **1.1. Восстановление данных в полном объёме за предыдущий день**  
Подойдёт **полное резервное копирование (Full Backup)**, выполняемое ежедневно.  
- **Преимущества**: простота восстановления, так как все данные хранятся в одной резервной копии.  
- **Недостатки**: требует больше места и времени на создание.  

### **1.2. Восстановление данных за час до поломки**  
Лучше использовать **инкрементное (Incremental Backup)** или **дифференциальное (Differential Backup)** копирование в сочетании с **транзакционными логами (WAL в PostgreSQL, binlog в MySQL)**.  
- **Инкрементное**: копируются только изменения с последнего бэкапа (экономит место, но восстановление сложнее).  
- **Дифференциальное**: копируются все изменения с последнего полного бэкапа (быстрее восстановление, но занимает больше места).  
- **Транзакционные логи**: позволяют восстановить состояние на конкретный момент времени (Point-in-Time Recovery, PITR).  

### **1.3. Моментальное переключение на работающую базу**  
Да, это возможно с помощью:  
- **Репликации (Master-Slave, Master-Master)** – автоматическое переключение при отказе мастера.  
- **Кластерных решений (PostgreSQL + Patroni, MySQL Group Replication, Galera Cluster)** – автоматический failover.  
- **Использование балансировщиков (HAProxy, ProxySQL)** – перенаправление запросов на рабочую ноду.  

---

## **Задание 2. PostgreSQL**  

### **2.1. Пример резервирования и восстановления**  
**Резервирование (pg_dump):**  
```bash
pg_dump -U username -d dbname -F c -f backup.dump  # Custom format (сжатый)
pg_dump -U username -d dbname -F p -f backup.sql   # Plain SQL
```
**Восстановление (pg_restore):**  
```bash
pg_restore -U username -d dbname -C backup.dump  # Создаёт БД, если её нет
pg_restore -U username -d existing_db backup.dump  # Восстановление в существующую БД
```
**Point-in-Time Recovery (PITR):**  
```bash
# Настройка архивации WAL в postgresql.conf:
wal_level = replica
archive_mode = on
archive_command = 'cp %p /path/to/wal_archive/%f'

# Восстановление до определённого времени:
pg_restore --recovery-target-time="2024-01-01 12:00:00" /path/to/wal_archive/
```

### **2.1.* Автоматизация резервного копирования**  
Да, можно автоматизировать с помощью:  
- **cron + pg_dump** (ежедневные/еженедельные бэкапы).  
- **Barman (PgBarman)** – специализированный инструмент для резервного копирования PostgreSQL.  
- **WAL-G** – облачное резервное копирование с поддержкой S3, GCS.  
- **ZFS/Btrfs snapshots** – моментальные снимки файловой системы.  

---

## **Задание 3. MySQL**  

### **3.1. Инкрементное резервное копирование**  
**С использованием `mysqlbinlog` (на основе binlog):**  
```bash
# Полный бэкап:
mysqldump -u root -p --all-databases --single-transaction --flush-logs --master-data=2 > full_backup.sql

# Инкрементный бэкап (копирование новых binlog-файлов):
mysqlbinlog --start-datetime="2024-01-01 00:00:00" /var/lib/mysql/mysql-bin.000123 > incr_backup.sql
```
**С использованием Percona XtraBackup (инкрементный бэкап):**  
```bash
# Полный бэкап:
xtrabackup --backup --target-dir=/backup/full

# Инкрементный бэкап (изменения с последнего полного бэкапа):
xtrabackup --backup --target-dir=/backup/incr --incremental-basedir=/backup/full
```

### **3.1.* Преимущества репликации перед обычным бэкапом**  
- **Минимальный downtime**: при отказе мастера можно быстро переключиться на реплику.  
- **Чтение без нагрузки на мастер**: реплики могут использоваться для отчётов.  
- **Геораспределение**: реплики в другом дата-центре повышают отказоустойчивость.  
- **Тестирование**: на реплике можно проверять обновления без риска для продакшена.  

**Недостатки репликации**:  
- Не защищает от логических ошибок (например, `DROP TABLE` на мастере повторится на реплике).  
- Требует больше ресурсов.  